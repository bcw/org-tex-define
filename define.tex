% Created 2016-08-21 Sun 20:36
\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{fixltx2e}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{textcomp}
\usepackage{marvosym}
\usepackage{wasysym}
\usepackage{amssymb}
\usepackage{hyperref}
\tolerance=1000
\RequirePackage{fancyvrb}
\DefineVerbatimEnvironment{verbatim}{Verbatim}{fontsize=\scriptsize}
\newcommand{\mat}[1]{\mathbf{#1}}
\author{Brian C. Wells}
\date{\today}
\title{Org mode \LaTeX{} macros (for both HTML and \LaTeX{} export)}
\hypersetup{
  pdfkeywords={},
  pdfsubject={},
  pdfcreator={Emacs 24.5.1 (Org mode 8.2.10)}}
\begin{document}

\maketitle
\tableofcontents

This document should be exported to \href{define.html}{HTML} and \href{define.tex}{\LaTeX{}} to check that the
proper code is generated.  \href{define.pdf}{A PDF file} should also be available, but
looks a bit bad because Org mode macros \emph{must} be written on a single
line, and some of these macros overfill the line (even in a fairly
small font).

This Literate Program is an Org mode setup file that makes it easy to
define \LaTeX{} macros that work in \emph{both} \LaTeX{} and HTML export.  To
"tangle" the source code (\verb~define.org~) for this document to generate
the \verb~define.setup~ file, type the key sequence \verb~C-c C-v t~ in Emacs
(with the default keymap).  The first line makes sure that the file
can be edited in org-mode despite the file being named with an
extension of \verb~.setup~.

\begin{verbatim}
# -*- mode: org -*-
#+MACRO: when-fmt (eval (when (org-export-derived-backend-p org-export-current-backend '$1) "$2"))
#+MACRO: preamble {{{when-fmt(html,\\($1\\))}}}{{{when-fmt(latex,#+LATEX_HEADER: $1)}}}
#+MACRO: define   {{{preamble(\\newcommand{$1}$2)}}}
\end{verbatim}

\section*{Define the Org mode macros}
\label{sec-1}

\subsection*{when-fmt macro}
\label{sec-1-1}

This is inspired by the \verb~if-latex-else~ macro under the `Advanced'
heading here: \url{https://github.com/fniessen/org-macros}. Apparently,
Org mode will evalute Emacs Lisp code in macros, although I have not
yet found any documentation that explains \emph{why} this works.

The \verb~when~ form is like \verb~if~, except it only returns a string when the
condition is true, returning \verb~nil~ instead when it is false.  We use
\verb~when~ because we want to perform an action for \LaTeX{} and HTML
formats, and we do not want to assume that the user wants the same
behavior for all non-\LaTeX{} or non-HTML formats.

\begin{verbatim}
#+MACRO: when-fmt (eval (when (org-export-derived-backend-p org-export-current-backend '$1) "$2"))
\end{verbatim}

Since the second parameter \verb~$2~ is used inside quotes, it will be
necessary to double any backslashes, despite the fact that Org mode
macros do not normally require this (except between parameters).

\subsection*{preamble macro}
\label{sec-1-2}

Using the \hyperref[sec-1-1]{when-fmt macro}, we wrap HTML output in \verb~\(...\)~ so that \href{http://docs.mathjax.org/en/latest/tex.html#defining-tex-macros}{the
MathJax library will recognize that it should process them}.  So long
as we only use this to define \LaTeX{} macros, MathJax will not generate
any spurious output.  In \LaTeX{} output, we use the \verb~#+LATEX_HEADER:~
Org mode syntax to ensure that it is put in the proper \LaTeX{} preamble.

\begin{verbatim}
#+MACRO: preamble {{{when-fmt(html,\\($1\\))}}}{{{when-fmt(latex,#+LATEX_HEADER: $1)}}}
\end{verbatim}

\subsection*{define macro}
\label{sec-1-3}

Using the \hyperref[sec-1-2]{preamble macro}, we specify a macro that uses the \LaTeX{}
\verb~\newcommand~ macro to define macros.  The first argument is the macro
command sequence, and the second argument is whatever \LaTeX{} code is
needed for the definition.  Note that we wrap the command sequence in
\verb~{...}~ automatically, since this is always done.  The second
parameter is not, however, because it is sometimes necessary to write
a number in square brackets \verb~[...]~ when the macro takes parameters.

\begin{verbatim}
#+MACRO: define   {{{preamble(\\newcommand{$1}$2)}}}
\end{verbatim}

\section*{Usage Example}
\label{sec-2}

Say you want to define a \verb~\mat~ command to write the names of
matrices, as in \verb~\mat{A}~ for $\mat{A}$.

At the beginning of the file, you should add
\begin{verbatim}
#+SETUPFILE: define.setup
\end{verbatim}
and then you can write
\begin{verbatim}
{{{define(\\mat,[1]{\\mathbf{#1}})}}}
\end{verbatim}
and use it as follows:
\begin{verbatim}
$\mat{A}$
\end{verbatim}

Again, remember: it is necessary to double the backslashes.  And the
result looks like this: $\mat{A}$.
% Emacs 24.5.1 (Org mode 8.2.10)
\end{document}